appId: com.jimmysolutions.strengthassistant.test
---
# Test: Sync Queue Persistence Through App Restart
# Purpose: Verify sync queue persists through app restarts (core bug test)
# 
# This test specifically targets the queue persistence issue without 
# requiring airplane mode, making it more reliable for CI/CD

- launchApp

# Handle authentication - continue as guest (optional if already authenticated)
- tapOn:
    id: "continue-as-guest"
    optional: true

# Navigate to exercises
- tapOn:
    id: "exercisesTab"

# Force the app into a sync-pending state
# This can be done by creating exercises and then simulating sync failure
- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"

# Enable sync debugging mode
- tapOn:
    id: "enable-sync-debugging"

# Set sync to fail mode (simulates server unavailable)
- tapOn:
    id: "force-sync-failures"
- assertVisible:
    text: "Sync failures enabled"

# Navigate back to exercises
- tapOn:
    id: "exercisesTab"

# Add exercises that will fail to sync
- tapOn:
    id: "add-exercise"
- tapOn:
    id: "name"
- inputText: "Persistence Test 1"
- tapOn:
    id: "submit"

- tapOn:
    id: "add-exercise"
- tapOn:
    id: "name"
- inputText: "Persistence Test 2"
- tapOn:
    id: "submit"

- tapOn:
    id: "add-exercise"
- tapOn:
    id: "name"
- inputText: "Persistence Test 3"
- tapOn:
    id: "submit"

# Verify exercises are created locally
- assertVisible:
    text: "Persistence Test 1"
- assertVisible:
    text: "Persistence Test 2"
- assertVisible:
    text: "Persistence Test 3"

# Try to trigger sync (will fail due to forced failure mode)
- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"
- tapOn:
    id: "force-sync-now"

# Verify sync queue has pending operations
- assertVisible:
    text: "Pending Sync Operations: 3"

# Verify sync status shows failed/pending
- assertVisible:
    id: "sync-status-pending"

# CRITICAL TEST: Restart app with pending sync operations
- stopApp
- launchApp

# Navigate back to settings to check sync queue
- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"

# CRITICAL ASSERTION: Sync queue should be restored after restart
# This is the main bug - if this passes, queue persistence is working
- assertVisible:
    text: "Pending Sync Operations: 3"

# Verify exercises are still visible
- tapOn:
    id: "exercisesTab"
- assertVisible:
    text: "Persistence Test 1"
- assertVisible:
    text: "Persistence Test 2"
- assertVisible:
    text: "Persistence Test 3"

# Now restore sync functionality and verify recovery
- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"

# Disable sync failures
- tapOn:
    id: "disable-sync-failures"
- assertVisible:
    text: "Sync failures disabled"

# Trigger sync recovery
- tapOn:
    id: "force-sync-now"

# Verify sync queue is now empty (assertVisible waits automatically)
- assertVisible:
    text: "Pending Sync Operations: 0"

# Verify sync status is healthy
- assertVisible:
    id: "sync-status-synced"

# Final test: Restart again to ensure everything is stable
- stopApp
- launchApp

# Verify exercises are still there and sync is healthy
- tapOn:
    id: "exercisesTab"
- assertVisible:
    text: "Persistence Test 1"
- assertVisible:
    text: "Persistence Test 2"
- assertVisible:
    text: "Persistence Test 3"

- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"
- assertVisible:
    text: "Pending Sync Operations: 0"

# Check for any uncaught errors
# Check for any sync errors
- assertNotVisible:
    id: "maestro-error-blocker"

# Clean up test data
- tapOn:
    id: "exercisesTab"

- tapOn:
    text: "Persistence Test 1"
- tapOn:
    id: "delete-exercise-button"
- tapOn:
    text: "Delete"

- tapOn:
    id: "exercisesTab"
- tapOn:
    text: "Persistence Test 2"
- tapOn:
    id: "delete-exercise-button"
- tapOn:
    text: "Delete"

- tapOn:
    id: "exercisesTab"
- tapOn:
    text: "Persistence Test 3"
- tapOn:
    id: "delete-exercise-button"
- tapOn:
    text: "Delete"

# Disable debug mode
- tapOn:
    id: "profileTab"
- tapOn:
    text: "Developer Options"
- tapOn:
    id: "disable-sync-debugging"