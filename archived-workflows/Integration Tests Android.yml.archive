name: Integration Tests Android

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  build-preview:
    runs-on: ubuntu-latest
    environment: Dev
    steps:
      - name: 🏗 Checkout repository
        uses: actions/checkout@v4

      - name: Build Preview APK
        uses: ./.github/actions/android-build
        with:
          build-type: preview
          devbox-config: android-build
          artifact-name: preview_build
        id: build-preview

  integration-tests-android:
    runs-on: ubuntu-latest
    needs: build-preview
    steps:
      - name: 🏗 Checkout repository
        uses: actions/checkout@v4

      - name: Run Integration Tests
        uses: ./.github/actions/maestro-test
        with:
          apk-path: preview_build
          test-environment: integration
          skip-data-cleanup: false
          devbox-config: android-testing
        id: integration-tests
