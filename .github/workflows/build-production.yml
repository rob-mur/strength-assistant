name: Build Production APK

on:
  workflow_run:
    workflows:
      [
        "Unit Tests",
        "Integration Tests Android",
        "Integration Tests Chrome",
        "SonarQube",
      ]
    types: [completed]
    branches: ["main"]
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment: Dev
    # Only run if all previous workflows succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: üèó Checkout repository
        uses: actions/checkout@v4

      - name: Build Production APK
        uses: ./.github/actions/android-build
        with:
          build-type: production
          devbox-config: android-build
          artifact-name: production-release-apk
        id: build-production

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            Production build from commit ${{ github.sha }}
            Build successful: ${{ steps.build-production.outputs.build-successful }}

            Changes: ${{ github.event.head_commit.message }}
          files: ${{ steps.build-production.outputs.apk-path }}
