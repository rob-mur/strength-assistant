name: Terraform Deploy

on:
  push:
    branches: [main]
    paths:
      - "terraform/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - production

concurrency:
  group: terraform-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: 🏗 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.0"

      - name: 📝 Create terraform.tfvars
        working-directory: terraform
        run: |
          cat << EOF > terraform.tfvars
          supabase_project_ref = "${{ secrets.SUPABASE_PROJECT_REF }}"
          supabase_access_token = "${{ secrets.SUPABASE_ACCESS_TOKEN }}"
          environment = "${{ github.event.inputs.environment || 'dev' }}"
          EOF

      - name: 🚀 Terraform Init
        working-directory: terraform
        run: terraform init

      - name: 📋 Terraform Plan
        working-directory: terraform
        run: terraform plan -out=tfplan

      - name: ✅ Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: 📤 Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment || 'dev' }}
          path: terraform/tfplan
          retention-days: 30
