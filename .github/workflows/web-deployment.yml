name: Deploy Web Application

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment (production or preview)"
        required: true
        type: string
      pr_number:
        description: "Pull request number for preview deployments"
        required: false
        type: string
    outputs:
      deployment_url:
        description: "URL of the deployed web application"
        value: ${{ jobs.deploy.outputs.deployment_url }}
      deployment_status:
        description: "Status of the deployment"
        value: ${{ jobs.deploy.outputs.deployment_status }}

env:
  NODE_ENV: production

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'production' && 'Dev' || 'preview' }}
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”‘ Setup Environment Variables
        id: env-setup
        run: |
          echo "Setting up environment variables for web deployment..."

          # Create .env.local file with production Supabase credentials
          echo "Creating .env.local with production credentials..."
          cat > .env.local << EOF
          EXPO_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL || secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY || secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_ENVIRONMENT=${{ inputs.environment }}
          EXPO_PUBLIC_PR_NUMBER=${{ inputs.pr_number || '' }}
          EOF

          # Verify .env.local file was created
          if [ ! -f .env.local ]; then
            echo "âŒ Failed to create .env.local file"
            exit 1
          fi

          echo "âœ… Environment variables configured:"
          echo "- SUPABASE_URL: ${EXPO_PUBLIC_SUPABASE_URL:0:50}..."
          echo "- ENVIRONMENT: ${{ inputs.environment }}"
          echo "- PR_NUMBER: ${{ inputs.pr_number || 'none' }}"

          # Source the environment file to make variables available
          source .env.local

          # Verify required variables are set
          if [ -z "$EXPO_PUBLIC_SUPABASE_URL" ] || [ -z "$EXPO_PUBLIC_SUPABASE_ANON_KEY" ]; then
            echo "âŒ Missing required Supabase environment variables"
            echo "Please ensure SUPABASE_URL and SUPABASE_ANON_KEY are set in GitHub secrets"
            exit 1
          fi

          # Add environment variables to GitHub environment for subsequent steps
          echo "EXPO_PUBLIC_SUPABASE_URL=${EXPO_PUBLIC_SUPABASE_URL}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=${EXPO_PUBLIC_SUPABASE_ANON_KEY}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          echo "EXPO_PUBLIC_PR_NUMBER=${{ inputs.pr_number || '' }}" >> $GITHUB_ENV

      - name: ğŸ” Verify Expo web build capability
        run: |
          echo "Checking if expo export command is available..."
          npx expo --version
          echo "Checking package.json for web build script..."
          npm run build_web --dry-run || echo "Using direct expo export command"

      - name: ğŸŒ Build Expo Web
        run: |
          echo "Building web application with environment variables..."

          echo "Environment check:"
          echo "SUPABASE_URL: ${EXPO_PUBLIC_SUPABASE_URL:0:50}..."
          echo "SUPABASE_KEY: ${EXPO_PUBLIC_SUPABASE_ANON_KEY:0:20}..."
          echo "ENVIRONMENT: ${EXPO_PUBLIC_ENVIRONMENT}"
          echo "PR_NUMBER: ${EXPO_PUBLIC_PR_NUMBER}"

          # Verify .env.local file exists 
          if [ -f .env.local ]; then
            echo "Using .env.local file:"
            cat .env.local | grep -v "ANON_KEY" || true  # Show env vars but hide anon key
          fi

          # Build with environment variables
          echo "Building with: npx expo export -p web"
          npx expo export -p web

          echo "Build completed. Checking output..."
          ls -la dist/
          test -f dist/index.html || (echo "ERROR: index.html not found in dist/" && exit 1)

          # Verify environment variables are embedded in the build
          if grep -q "$EXPO_PUBLIC_SUPABASE_URL" dist/_expo/static/js/web/*.js; then
            echo "âœ… Supabase URL successfully embedded in build"
          else
            echo "âš ï¸ Warning: Supabase URL might not be embedded in build"
          fi

      - name: ğŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: ${{ inputs.environment == 'production' && '--prod' || '' }}
        # No additional env needed here - already baked into build

      - name: ğŸ“ Set deployment outputs
        run: |
          echo "deployment_url=${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_OUTPUT
          echo "deployment_status=success" >> $GITHUB_OUTPUT
          echo "supabase_url=${{ steps.eas-env.outputs.SUPABASE_URL }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ Web deployment completed successfully!"
          echo "ğŸ“± Deployment URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"

      - name: âŒ Deployment Failure
        if: failure()
        run: |
          echo "ğŸ’¥ Web deployment failed!"
          echo "ğŸ“‹ Check the logs above for detailed error information"
          echo "ğŸ”§ Common issues:"
          echo "  - Missing environment variables"
          echo "  - Build command failure"
          echo "  - Vercel authentication issues"
          exit 1
