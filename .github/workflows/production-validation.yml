name: Production Validation

on:
  workflow_dispatch:
    inputs:
      terraform_deployment_id:
        description: "Terraform deployment ID that triggered this validation"
        required: true
        type: string

  # Trigger automatically after terraform workflow completes
  workflow_run:
    workflows: ["Terraform Deploy", "Infrastructure Deploy"]
    types: [completed]
    branches: [main]

env:
  SKIP_DATA_CLEANUP: true
  NODE_ENV: production

jobs:
  production-validation:
    name: Validate against Production Infrastructure
    runs-on: ubuntu-latest

    # Only run if terraform deployment succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Use parameterized Android Build Action
      - name: Build Production APK
        uses: ./.github/actions/android-build
        with:
          build-type: production
          devbox-config: android-build
          artifact-name: production-apk
        id: build-apk

      # Use parameterized Maestro Test Action
      - name: Run Maestro Tests Against Production
        uses: ./.github/actions/maestro-test
        with:
          apk-path: production-apk
          test-environment: production
          skip-data-cleanup: true
          devbox-config: android-testing
        id: maestro-tests

      # Process results
      - name: Process Test Results
        run: |
          echo "Production validation completed"
          echo "Build successful: ${{ steps.build-apk.outputs.build-successful }}"
          echo "Tests passed: ${{ steps.maestro-tests.outputs.tests-passed }}"

      # Alert on failure - GitHub will automatically send email notifications
      - name: Production Validation Failed
        if: failure()
        run: |
          echo "::error title=Production Validation Failed::Production validation against deployment ${{ github.event.inputs.terraform_deployment_id }} has failed. Manual intervention required."
          echo "::error::Frontend deployment should be blocked pending investigation"
          echo "::error::Check the logs and artifacts for details on the failure"
          exit 1

      # Success notification
      - name: Production Validation Succeeded
        if: success()
        run: |
          echo "::notice title=Production Validation Passed::Production validation against deployment ${{ github.event.inputs.terraform_deployment_id }} completed successfully"
          echo "::notice::Frontend deployment can proceed with confidence"
