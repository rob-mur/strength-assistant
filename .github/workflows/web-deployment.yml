name: Deploy Web Application

on:
  workflow_call:
    inputs:
      environment:
        description: "Deployment environment (production or preview)"
        required: true
        type: string
      pr_number:
        description: "Pull request number for preview deployments"
        required: false
        type: string
    outputs:
      deployment_url:
        description: "URL of the deployed web application"
        value: ${{ jobs.deploy.outputs.deployment_url }}
      deployment_status:
        description: "Status of the deployment"
        value: ${{ jobs.deploy.outputs.deployment_status }}

env:
  NODE_ENV: production

jobs:
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'production' && 'Dev' || 'preview' }}
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
      deployment_status: ${{ steps.deploy.outputs.deployment_status }}

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”‘ Get Supabase Anon Key
        id: supabase-config
        run: |
          echo "Fetching Supabase project configuration..."
          
          # Get project settings from Supabase Management API
          PROJECT_REF="${{ secrets.SUPABASE_PROJECT_REF }}"
          ACCESS_TOKEN="${{ secrets.SUPABASE_ACCESS_TOKEN }}"
          
          if [ -z "$PROJECT_REF" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ Missing Supabase credentials"
            echo "PROJECT_REF available: $([[ -n "$PROJECT_REF" ]] && echo 'yes' || echo 'no')"
            echo "ACCESS_TOKEN available: $([[ -n "$ACCESS_TOKEN" ]] && echo 'yes' || echo 'no')"
            exit 1
          fi
          
          # Fetch project configuration to get anon key
          echo "ğŸ“¡ Fetching project configuration from Supabase API..."
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.supabase.com/v1/projects/$PROJECT_REF/config")
          
          HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -e 's/HTTPSTATUS:.*//g')
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Failed to fetch Supabase config. HTTP Status: $HTTP_STATUS"
            echo "Response: $BODY"
            exit 1
          fi
          
          # Extract anon key from response
          ANON_KEY=$(echo "$BODY" | jq -r '.jwt_secret // .anon_key // empty')
          
          if [ -z "$ANON_KEY" ] || [ "$ANON_KEY" = "null" ]; then
            echo "âŒ Could not extract anon key from Supabase config"
            echo "Available keys in response:"
            echo "$BODY" | jq -r 'keys[]' || echo "Failed to parse JSON"
            exit 1
          fi
          
          echo "âœ… Successfully retrieved Supabase configuration"
          echo "SUPABASE_URL=https://$PROJECT_REF.supabase.co" >> $GITHUB_OUTPUT
          echo "SUPABASE_ANON_KEY=$ANON_KEY" >> $GITHUB_OUTPUT
          
          # Mask the anon key in logs
          echo "::add-mask::$ANON_KEY"

      - name: ğŸ” Verify Expo web build capability
        run: |
          echo "Checking if expo export command is available..."
          npx expo --version
          echo "Checking package.json for web build script..."
          npm run build_web --dry-run || echo "Using direct expo export command"

      - name: ğŸŒ Build Expo Web
        run: |
          echo "Building web application..."
          echo "Environment check:"
          echo "SUPABASE_URL: ${EXPO_PUBLIC_SUPABASE_URL:0:50}..."
          echo "SUPABASE_KEY: ${EXPO_PUBLIC_SUPABASE_ANON_KEY:0:20}..."
          echo "ENVIRONMENT: $EXPO_PUBLIC_ENVIRONMENT"
          npx expo export -p web
          echo "Build completed. Checking output..."
          ls -la dist/
          test -f dist/index.html || (echo "ERROR: index.html not found in dist/" && exit 1)
        env:
          # Environment variables for Expo build - using retrieved config
          EXPO_PUBLIC_SUPABASE_URL: ${{ steps.supabase-config.outputs.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ steps.supabase-config.outputs.SUPABASE_ANON_KEY }}
          EXPO_PUBLIC_ENVIRONMENT: ${{ inputs.environment }}
          EXPO_PUBLIC_PR_NUMBER: ${{ inputs.pr_number || '' }}

      - name: ğŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          vercel-args: ${{ inputs.environment == 'production' && '--prod' || '' }}
        # No additional env needed here - already baked into build

      - name: ğŸ“ Set deployment outputs
        run: |
          echo "deployment_url=${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_OUTPUT
          echo "deployment_status=success" >> $GITHUB_OUTPUT
        shell: bash

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ Web deployment completed successfully!"
          echo "ğŸ“± Deployment URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "ğŸŒ Environment: ${{ inputs.environment }}"

      - name: âŒ Deployment Failure
        if: failure()
        run: |
          echo "ğŸ’¥ Web deployment failed!"
          echo "ğŸ“‹ Check the logs above for detailed error information"
          echo "ğŸ”§ Common issues:"
          echo "  - Missing environment variables"
          echo "  - Build command failure"
          echo "  - Vercel authentication issues"
          exit 1
